---
import Layout from '../../../layouts/Layout.astro'
import AudioLoader from '../../../components/AudioLoader.astro';
import Speaking from '../../../components/Speaking.astro';
import Home from '../../../components/Home.astro'

---

<Layout title="Speaking">
    <AudioLoader/>
	<Home/>
     <Speaking/>

     <audio src="/mock-tests/test10/1.mp3" id="audio1"></audio>
     <audio src="/mock-tests/test10/2.mp3" id="audio2"></audio>
     <audio src="/mock-tests/test10/3.mp3" id="audio3"></audio>
     <audio src="/mock-tests/test10/4.mp3" id="audio4"></audio>
     <audio src="/mock-tests/test10/5.mp3" id="audio5"></audio>
     <audio src="/mock-tests/test10/6.mp3" id="audio6"></audio>
     <audio src="/mock-tests/test10/part2/intro.mp3" id="audio7"></audio>
     <audio src="/mock-tests/test10/part2/1.mp3" id="audio8"></audio>
	 <audio src="/mock-tests/test10/part3/intro.mp3" id="audio9"></audio>
	 <audio src="/mock-tests/test10/part3/1.mp3" id="audio10"></audio>
	 <audio src="/mock-tests/test10/part3/2.mp3" id="audio11"></audio>
	 <audio src="/mock-tests/test10/part3/3.mp3" id="audio12"></audio>
	 <audio src="/mock-tests/test10/part3/4.mp3" id="audio13"></audio>
	 <audio src="/mock-tests/test10/part3/5.mp3" id="audio14"></audio>
	 <audio src="/mock-tests/test10/part3/end.mp3" id="audio15"></audio>
                        
</Layout>

<script is:inline>

var q=[
   'What is the weather like in your country?',
   'Do you like the weather in your country?',
   'Is the weather the same in all parts of your country?',
   'Are there any problems with the climate in your country?',
   'Does the weather ever affect the way you feel?',
   'Is your country popular with tourists in every season?',
   '<p><b>Describe your favourite season.</b></p><p>You should say:</p><ul><li>what the season is and when it occurs</li><li>what the weather is like during this season</li><li>what your typical activities are during this season</li><li>and explain why it is your favourite season.</li></ul><br><textarea class="form-control" id="exampleFormControlTextarea1" rows="3" placeholder="Izoh yozish uchun"></textarea>',
   'How do the different seasons affect the lifestyle of people in your country?',
   'Do you think people who live in cold places have different personalities to people who live in warm or hot places?',
   'Do you think there are any problems with the world\'s climate now?',
   'In your opinion, is anything we can do to prevent bad weather?',
   'How easy or difficult is it to predict the weather in your country?'
	]

</script>

<script>
  let recorder, audioChunks = [];
  const question = document.getElementById("question")
  var loader = document.querySelector('.transition-loader')
  import { app } from "@lib/firebase/client";
import { getFirestore, doc, updateDoc } from "firebase/firestore";
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";

const storage = getStorage(app);
const db = getFirestore(app)
const uid=localStorage.getItem("storeId")
// Get the current date
const currentDate = new Date();

// Format the date as YYYY-MM-DD
const formattedDate = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;

const formattedTime = `${currentDate.getHours().toString().padStart(2, '0')}-${currentDate.getMinutes().toString().padStart(2, '0')}`;

// Generate the audio file name
const fileName = `audio_${formattedDate}_${formattedTime}`;

const storageRef = ref(storage, '/answers/' + fileName);
  

  function startRecording() {
	navigator.mediaDevices.getUserMedia({ audio: true })
	  .then(function (stream) {
		recorder = new MediaRecorder(stream); 
		recorder.ondataavailable = (event) => {

if (event.data.size > 0) {
  audioChunks.push(event.data);
}

let audioAnswer = new Blob(audioChunks, { type: 'audio/mp3' });


const formData = new FormData();
		  formData.append('audio', audioAnswer, 'audio.wav');
		  formData.append('caption', question.innerText);
		  formData.append('title', "Multilevel Mock");
		  fetch(`https://api.telegram.org/bot6124695087:AAG2TZUf4KjJrBQUM9OiO8DV6dSUwScqZ2A/sendAudio?chat_id=1483919112`, {
			method: 'POST',
			body: formData
		  })
			.then(response => {
				console.log(response)
                if (response.ok) {
					// 'file' comes from the Blob or File API
uploadBytes(storageRef, audioAnswer).then((snapshot) => {
  console.log('Uploaded a blob or file!');

  // Get the download URL
  getDownloadURL(storageRef).then( async (downloadURL) => {
    console.log('File available at', downloadURL);
	const AudioRef = doc(db, "users", uid );
      await updateDoc(AudioRef, {
      audio: downloadURL,
});
window.location.href='/speaking'
loader.classList.add('hidden')
  }).catch((error) => {
    // Handle any errors that occurred during the download URL generation
    console.error('Error getting download URL', error);
  });
});
					
                    } else {
                        // Handle non-ok response (optional)
                        alert('Failed to send audio:', response.status, response.statusText);
                        // You can show an error message or take other actions as needed
                    }
			})
			.catch(error => console.error(error));
 
};  
		recorder.start();
  
	  });
  }

const playBeep = ()=>{
   var beep = new Audio('/mock-tests/beep.m4a')
   beep.play()
}

function stopRecording() {
    recorder.stop();
  }

  function pauseRecording() {
    recorder.pause();
  }

  function resumeRecording() {
    recorder.resume();
  }






document.getElementById('start').addEventListener('click', ()=>{
	document.getElementById('home').classList.add('hidden')
	document.getElementById('speaking').classList.remove('hidden')
	step0()
})

    function step0() {
	$('#question').text(q[0]);
	$('#q-number').text(1)
	var audio = document.getElementById('audio1')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
        startRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			step1()
			pauseRecording()
            

  }
		  
		}, 1000);
	  }

}


function step1() {
	$('#question').text(q[1]);
	$('#q-number').text(2)
	var audio = document.getElementById('audio2')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
        resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			step2()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}



function step2() {
	$('#question').text(q[2]);
	$('#q-number').text(3)
	var audio = document.getElementById('audio3')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
            step3()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}


function step3() {
	$('#question').text(q[3]);
	$('#q-number').text(4)
	var audio = document.getElementById('audio4')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
            step4()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}



function step4() {
	$('#question').text(q[4]);
	$('#q-number').text(5)
	var audio = document.getElementById('audio5')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
            step5()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}



function step5() {
	$('#question').text(q[5]);
	$('#q-number').text(6)
	var audio = document.getElementById('audio6')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
            part2()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}


function part2(){
    $('#question').text('');
	$('#q-number').text('')
	var audio = document.getElementById('audio7')
    audio.play()
	audio.addEventListener("ended", step6)
    $('#indicator-2').removeClass('bg-blue-500')
    $('#indicator-2').addClass('active')
    

}

function step6() {
	$('#question').html(q[6]);
	$('#q-number').text(7)
	var audio = document.getElementById('audio8')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 60;
	$('#timer').text(` 00:${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 120;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			part3()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}


function part3(){
    $('#question').text('');
	$('#q-number').text('')
	var audio = document.getElementById('audio9')
    audio.play()
	audio.addEventListener("ended", step7)
    $('#indicator-3').removeClass('bg-blue-500')
    $('#indicator-3').addClass('active')
    

}


function step7() {
	$('#question').html(q[7]);
	$('#q-number').text(8)
	var audio = document.getElementById('audio10')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			step8()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}


function step8() {
	$('#question').html(q[8]);
	$('#q-number').text(9)
	var audio = document.getElementById('audio11')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			step9()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}
 


function step9() {
	$('#question').html(q[9]);
	$('#q-number').text(10)
	var audio = document.getElementById('audio12')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			step10()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}


function step10() {
	$('#question').html(q[10]);
	$('#q-number').text(11)
	var audio = document.getElementById('audio13')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			step11()
			pauseRecording()
  }
		  
		}, 1000);
	  }


}
 

function step11() {
	$('#question').html(q[11]);
	$('#q-number').text(12)
	var audio = document.getElementById('audio14')
    audio.play()
	audio.addEventListener("ended", startCountdown)
    
    function startCountdown() {
	let count = 5;
	$('#timer').text(` 00:0${count}`);
	const interval = setInterval(() => {
	  count--;
	  $('#timer').text(` 00:0${count}`);
	  if (count <= 0) {
		playBeep()
		clearInterval(interval);
		start30SecondCountdown();
		resumeRecording()
	  }
	}, 1000);
  }


  function start30SecondCountdown() {
    $('#recorder-blink').removeClass('hidden')
		let count = 30;
		$('#timer').text(` 00:${count}`);
		const interval = setInterval(() => {
		  count--;
		  $('#timer').text(`00:${count}`);
		  if (count <= 0) {
			$('#timer').text(`00:00`)
			clearInterval(interval);
            $('#recorder-blink').addClass('hidden')
			examEnd()
  }
		  
		}, 1000);
	  }


}

function examEnd(){
    $('#question').text('');
	$('#q-number').text('')
	var audio = document.getElementById('audio15')
    audio.play()
	audio.addEventListener("ended", ()=>{
		stopRecording()
		loader.classList.remove('hidden')
	})	
}
 
</script>
