---
import { app } from "@lib/firebase/server";
import { getAuth } from "firebase-admin/auth";
import Layout from "@layouts/Layout.astro";
import Back from "@components/Back.astro";
import { getFirestore } from "firebase-admin/firestore";


const auth = getAuth(app);
const db = getFirestore(app)

/* Check current session */
if (!Astro.cookies.has("session")) {
  return Astro.redirect("/signin");
}
const sessionCookie = Astro.cookies.get("session").value;
const decodedCookie = await auth.verifySessionCookie(sessionCookie);
const user = await auth.getUser(decodedCookie.uid);

if (!user) {
  return Astro.redirect("/signin");
}


const userRef = db.collection("users").doc(user.uid)
const userSnapshot = await userRef.get();
const userData = userSnapshot.data();

const {name, email, status, tariff, joined, expiresAt, telegramName} = userData

if(status==="unpaid"){
return Astro.redirect("/price");
}

if(tariff==="basic"){
return Astro.redirect("/pay");
}


---

<Layout title="Essay">
<header class="w-full sticky top-0 bg-slate-700 shadow-lg flex justify-between items-center px-5 text-xl font-semibold text-gray-100">
<div class="flex items-center">
    <Back/>
<h1>Essay Generator</h1>
</div>
<p>{telegramName}</p>
</header>
 <form id="essayForm" class="md:colums-2 flex flex-col justify-start items-center">
    <h1 class="text-3xl font-semibold py-4 text-gray-100">Generate Your Essay</h1>
    <input required class="container mt-5 mx-auto px-4 p-4 text-gray-200 outline-none bg-gray-900 rounded-lg border-2 border-gray-800 font-bold" id="question" name="question" placeholder="Generatsiya qilish uchun essay savolini kiriting...">

    <div class="hidden text-white text-xl" id="resultContainer">
   <ul class="my-4 container mx-auto px-4">
    <li id="result"><li>
   </ul>
  </div>

    <button id="btn" class="flex items-center mt-4 mb-3 bottom-3 px-8 bg-gray-900 text-white text-lg rounded-lg py-2 px-4 font-semibold shadow-xl" type="button">
     ⚙️ Generate an essay</button>
  </form>

</Layout>
  



<script>
  
$(function () {

$('#btn').click(async()=>{
 
    document.getElementById('btn').innerText="⏳ Generating..."
    


      const question = $("#question").val()
      
      try {

    const jsonString = JSON.stringify({question});
    console.log(jsonString)
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: jsonString,
    });

    const result = await response.json();
    const resultContainer = document.getElementById('resultContainer');
    const resultDiv = document.getElementById('result');
    $('#btn').hide()
    $("#question").hide()
    resultContainer.classList.remove('hidden');
    resultDiv.innerHTML = "";

    const essayText = result.choices[0].text;
        const paragraphs = essayText.split('\n\n');
        // Format paragraphs with <p> tags
        const formattedEssay = paragraphs.join('\n\n');
     resultDiv.innerHTML = `<b>${question}</b> <br>${formattedEssay}`

  } catch (error) {
    console.error("Error sending JSON data:", error);
  }
})
    

    
});
</script>
